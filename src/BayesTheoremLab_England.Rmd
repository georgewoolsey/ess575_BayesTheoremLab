---
title: "ESS 575: Bayes Theorem Lab"
author: "Team England" 
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
linkcolor: blue
header-includes:
  - \usepackage{caption}
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding){ 
    out_dir <- '../';
    rmarkdown::render(inputFile, encoding = encoding, output_file=file.path(dirname(inputFile), out_dir, 'BayesTheoremLab_England.pdf')) 
  })
---

Team England:

  - Caroline Blommel
  - Carolyn Coyle
  - Bryn Crosby
  - George Woolsey
  
cblommel@mail.colostate.edu, carolynm@mail.colostate.edu, brcrosby@rams.colostate.edu, george.woolsey@colostate.edu


```{r setup, include=FALSE}
## load packages
library(tidyverse)
library(lubridate)
library(viridis)
library(scales)
library(latex2exp)

# knit options
knitr::opts_chunk$set(
  echo = TRUE
  , warning = FALSE
  , message = FALSE
  , fig.height = 5
  , fig.width = 7
)
# set seed
set.seed(10)
```

# Problem

You are interested in estimating the posterior distribution for the mean number of individuals of an invasive plant species per m^2^ in a disturbed grassland. We will call that mean $\theta$. You have prior information telling you that the average number of these plants per m^2^ is 10.2 with a standard deviation of the mean = .5. You have a set of fifty observations in hand obtained by sweaty labor in the field. Execute the following steps.

# Preliminaries

## 1

Simulate 50 data points from a Poisson distribution with mean $\theta$ = 6.4 to represent the data set. (This portrays the data that you gathered from plots, but it is lots easier to obtain.) What is the variance? Be sure to put the R function `set.seed(10)` before the call to `rpois()` to assure that we all get the same results. Call the data vector `y`.

```{r}
n <- 50
xx <- 6.4
y <- rpois(n = n, lambda = xx)
```

\textcolor{violet}{The variance ($\lambda$) of the simulated Poisson distribution with mean $\theta$ = 6.4 is:} **\textcolor{violet}{`r scales::comma(var(y), accuracy = .1)`}**

## 2

Plot a histogram of the data with density on the y-axis. It turns out that the histogram function in R is not really appropriate for discrete data (why?). Discover how to do a proper histogram for these data. Look into the `arm` package

```{r}
# summarize data for plotting
data.frame(
    y = y
  ) %>% 
  dplyr::count(y) %>% 
  dplyr::mutate(density = n / sum(n)) %>% 
# plot
  ggplot(., mapping = aes(x = y, y = density)) +
    geom_col(width = 0.7, fill = "navy", alpha = 0.8) +
    scale_x_continuous(
      breaks = seq(min(y)-1, max(y)+1, 1)
      , limits = c(min(y)-1, max(y)+1)
    ) +
    xlab("y") +
    ylab("density") +
    theme_bw()
```

\textcolor{violet}{The base histogram function in R is not really appropriate for discrete data because histograms are suited to continuous data which can be binned. Plotting data for categorical or discrete data is best accomplished in R using} `ggplot2::geom_col` or `ggplot2::geom_bar`

## 3

Set values for the prior mean (`mu.prior`) and standard deviation (`sigma.prior`). You have prior information telling you that the average number of these plants per m^2^ is 10.2 with a standard deviation of the mean = .5.

```{r}
mu.prior <- 10.2
sigma.prior <- 0.5
```


## 4.

Set up a vector containing a sequence of values for $\theta$, the mean number of invasive plants, You want this vector to approximate a continuous $\theta$, so be sure it contains values that are not too far apart. Use code like this: `theta = seq(0, 15, step)` where you set `step = .01`. Setting a value for `step` with global scope is important. You will use it later when you integrate.

```{r}
step <- .01
theta <- seq(0, 15, step)
```

# The prior distribution of $\theta$

## 5

Write the mathematical expression for a gamma prior on $\theta$. Be as specific as possible given the information at hand. Write an R function for the prior on $\theta$. The function for the prior should return a vector of gamma probability densities, one for each value of $\theta$. It should have arguments 1) the vector for $\theta$ you created in the previous step as well as 2) the prior mean and 3) the prior standard deviation. The mean and the standard deviation, of course, will need to be moment-matched to the proper parameters of the gamma distribution in your function. Recall that when a function is composed of a single statement as it is here, the statement can simply follow the function template on the same line; curly brackets are not needed. So, in this case `mu.prior = 10.2` and `sigma.prior = 0.5`. You could hard-code these in the function template, but that is bad practice.

```{r}
# define function
prior <- function(theta, mu, sigma){
  ########################
  # assume gamma dist
  ########################
  # calculate the shape alpha for gamma dist
  alpha <- (mu^2)/(sigma^2)
  # calculate the rate beta for gamma dist
  beta <- (mu)/(sigma^2)
  ## probability density f'
  d_gamma <- dgamma(x = theta, shape = alpha, rate = beta)
  return(d_gamma)
}
# return prior on theta
prior_theta <- prior(theta = theta, mu = mu.prior, sigma = sigma.prior)
```

## 6

Plot the prior distribution of $\theta$, the probability density of $\theta$ as a function of the values of $\theta$.

```{r}
# plot
data.frame(
  theta
  , prior_theta
) %>% 
ggplot(., mapping = aes(x = theta, y = prior_theta)) +
  geom_line(lwd = 1.2, color = "gray55") +
  xlab(latex2exp::TeX("$\\theta$")) +
  ylab(latex2exp::TeX("$\\[\\theta\\]$")) +
  labs(
    title = "Prior distribution"
  ) +
  theme_bw()
```

## 7

Check your moment matching by generating 100,000 random variates from a gamma distribution with parameters matched to the prior mean and standard deviation. Now compute the mean and standard deviation of the random variates. They should be very close to 10.2 and .5.

```{r}
n <- 100000
## calculate the shape alpha for gamma dist
alpha <- (mu.prior^2)/(sigma.prior^2)
## calculate the rate beta for gamma dist
beta <- (mu.prior)/(sigma.prior^2)
## probability density f'
r_gamma <- rgamma(n = n, shape = alpha, rate = beta)
```

\textcolor{violet}{The mean of the simulated gamma distribution with mean mu.prior = 10.2 and variance sigma.prior = 0.5 is:} **\textcolor{violet}{`r scales::comma(mean(r_gamma), accuracy = .01)`}**

\textcolor{violet}{The standard deviation of the simulated gamma distribution with mean mu.prior = 10.2 and variance sigma.prior = 0.5 is:} **\textcolor{violet}{`r scales::comma(sd(r_gamma), accuracy = .01)`}**

# The likelihood

## 8

What is the mathematical expression for the likelihood $[\mathbf{y} \mid \theta]$, assuming that the data are conditionally independent? Be as specific as possible using the information at hand. 

Write an R function for the likelihood. The function must use all `50` observations to compute the total likelihood across all of the data points (not the log likelihood) for each value of the vector $\theta$. It should have arguments for the vector $\theta$ and the data. The function should create and return a vector with elements $[\mathbf{y} \mid \theta_i]$. Note that this is the total probability density of all of the data for *each* value of $\theta_i$, not the probability density of a single data point. In reality, $\theta$ is a continuous random variable, the mean of the Poisson distribution. We are discretizing it here into small intervals. The function template will be something like:

### Mathematical expression for the likelihood $[\mathbf{y} \mid \theta]$

$$
[\mathbf{y} \mid \theta] = \prod_{i=1}^{50} \sf{Poisson} \mathrm{(y_{i} \mid \theta)}
$$
### Function for the likelihood

```{r}
like <- function(theta, y){
  #your code to calculate total likelihood of the data conditional on each value of theta
  temp_v <- numeric(length(theta))
  for(i in 1:length(theta)){
    temp_v[i] <- prod(
      dpois(x = y, lambda = theta[i], log = FALSE)
    )
  } 
  return(temp_v)
}
likelihood_y_theta <- like(theta = theta, y = y)
```

## 9

Plot the likelihood $[\mathbf{y} \mid \theta_i]$ holding the data constant and varying $\theta$. What is this plot called? Can you say anything about the area under the curve? What happens to the inference we can make based on likelihood alone if we multiply the curve by a constant?

```{r}
# plot
data.frame(
  theta
  , likelihood_y_theta
) %>% 
ggplot(., mapping = aes(x = theta, y = likelihood_y_theta)) +
  geom_line(lwd = 1.2, color = "gray35") +
  xlab(latex2exp::TeX("$\\theta$")) +
  ylab(latex2exp::TeX("$\\[y | \\theta\\]$")) +
  labs(
    title = "Likelihood profile"
  ) +
  theme_bw()
```

\textcolor{violet}{We use $[y \mid \theta]$ to assess the likelihood of different values of $\theta$ in light of the data. In this case, the function does not sum or integrate to one over all possible values of the parameter. The inference we can make based on likelihood alone if we multiply the curve by a constant is the same but would be proportional to the constant.}**

# The joint distribution

## 10 

What is the mathematical expression for the joint distribution $[\theta,\mathbf{y}]$? Your answer should be as specific as possible. I am not looking for the non-specific equation $[\theta, \mathbf{y}] = [\mathbf{y} \mid \theta][\theta]$. Create an R function for the joint distribution of the parameters and the data as the product of the prior and the likelihood functions. Call this function `joint`. The function should simply call the previous two functions and multiply them. Plot `joint(theta)` as a function of `theta`. Does this seem reasonable? Why are the values on the y axis so small? Think about what is going on here.

### Mathematical expression for the joint distribution $[\theta,\mathbf{y}]$

$$
[\mathbf{y} \mid \theta] = \prod_{i=1}^{50} \sf{Poisson} \mathrm{(y_{i} \mid \theta)}\; \cdot \; \sf{gamma}\mathrm{\Bigl(\theta \mid \frac{10.2^{2}}{0.5^{2}}, \frac{10.2}{.5^{2}}\Bigr)}
$$
### Function for the joint

```{r}
joint <- function(theta, y, mu, sigma){
  prior <- prior(theta = theta, mu = mu, sigma = sigma)
  likelihood <- like(theta = theta, y = y)
  return(likelihood * prior)
}
joint_theta <- joint(theta = theta, y = y, mu = mu.prior, sigma = sigma.prior)
```

### Plot `joint(theta)` as a function of `theta`

```{r}
data.frame(
  theta
  , joint_theta
) %>% 
ggplot(., mapping = aes(x = theta, y = joint_theta)) +
  geom_line(lwd = 1.2, color = "gray15") +
  xlab(latex2exp::TeX("$\\theta$")) +
  ylab(latex2exp::TeX("$\\[y | \\theta\\] \\cdot \\[\\theta\\]$")) +
  labs(
    title = "Joint"
  ) +
  theme_bw()
```

\textcolor{violet}{Yes, the values on the plot seem reasonable because the result is the product of the likelihood function and the prior distribution. The values on the y-axis are very small because the values on the y-axis of the likelihood function were very small and the values on the y-axis of the prior distribution were less than 1.}

